/*+ ETLM{depend:{replace:[
      {name:"BOOKER.BIN_EDIT_ENTRIES"},
      {name:"BOOKER.D_FNSKU_ASIN_MAP"},
      {name:"BOOKER.O_FCSKUS"},
      {name:"BOOKER.D_INVENTORY_ADJUSTMENT_ITEMS"},
      {name:"NA_ACS_MET_DDL.RECEIVE_DETAILS"}
    ]}}*/
with adjustments AS (
SELECT LEFT(r.receive_date, 10) AS receive_date
	, r.received_by
	, pallets.old_bin_id AS pallet_tag
    , ia.isbn AS asin
    , r.quantity AS rcv_qty
	, ia.bin_id AS adjust_container
    , SQRT(SUM(ia.quantity)^2) AS adjust_qty
    , ia.processed_by
    , ia.application_name
	, LEFT(ia.processed_datetime, 10) AS adjustment_date
    
FROM booker.d_inventory_adjustment_items AS ia

JOIN (
    SELECT bee.old_bin_id
        , COALESCE(fam.item_authority_id, ofc.fnsku, bee.isbn) AS asin
        , COALESCE(ofc.fnsku, bee.isbn) AS fnsku
        , bee.isbn
        , bee.new_bin_id
    	, SUM(bee.quantity) AS quantity
    FROM booker.bin_edit_entries AS bee
    
    LEFT JOIN
    (
    SELECT fcsku, fnsku
    FROM booker.o_fcskus
        WHERE region_id = '{REGION_ID}'
            AND is_active = 'Y'
    ) as ofc ON ofc.fcsku = bee.isbn
        
    LEFT JOIN
    (
    SELECT fulfillment_network_sku, item_authority_id
    FROM booker.d_fnsku_asin_map
        WHERE region_id = 1
        AND snapshot_day = TRUNC(GETDATE() -1)
    ) AS fam ON fam.fulfillment_network_sku = COALESCE(ofc.fnsku,bee.isbn)
    
    WHERE bee.region_id = '{REGION_ID}'
    AND bee.warehouse_id = '{WAREHOUSE_ID}'
    AND bee.snapshot_day > to_date ('{RUN_DATE_YYYYMMDD}', 'YYYYMMDD') - 31
    AND LEFT(bee.old_bin_id,3) = 'paX'
    
GROUP BY 1, 2, 3, 4, 5
    
) AS pallets ON pallets.new_bin_id = ia.bin_id AND pallets.asin = ia.isbn -- because 

JOIN ( -- the fact that this is a join rather than a left join excludes any pallets that were received more than a month ago
    SELECT receive_date
        , received_by
        , bin_id
        , fcsku
        , quantity
    FROM na_acs_met_ddl.receive_details
    WHERE region_id = '{REGION_ID}'
    AND warehouse_id = '{WAREHOUSE_ID}'
    AND receive_date >= to_date ('{RUN_DATE_YYYYMMDD}', 'YYYYMMDD') - 31
) AS r ON r.bin_id = pallets.old_bin_id AND r.fcsku = ia.isbn

WHERE ia.region_id = '{REGION_ID}'
AND ia.warehouse_id = '{WAREHOUSE_ID}'
AND ia.processed_day = to_date ('{RUN_DATE_YYYYMMDD}', 'YYYYMMDD')
AND LEFT(ia.bin_id,5) IN ('P-1-P','vtpaX') -- P-1-P are adjustment made post-stow, vtpaX are pre-stow adjustments
AND ia.application_name IN ('UnreceiveWebsite','WatsonCycleCount','DeleteItemsApp','AFTWatsonService')

GROUP BY 1, 2, 3, 4, 5, 6, 8, 9, 10
)

SELECT * FROM adjustments WHERE adjust_qty > 2;
